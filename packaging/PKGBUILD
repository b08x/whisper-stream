# Maintainer: b08x <b08x@users.noreply.github.com>
pkgname=whisper-stream
pkgver=1.0.1
pkgrel=5
pkgdesc="Continuous speech-to-text transcription using Groq API with interactive UI"
arch=('any')
url="https://github.com/b08x/whisper-stream"
license=('MIT')
depends=('curl' 'jq' 'sox' 'xclip' 'bash>=4.0')
optdepends=('pulseaudio: for audio device selection on Linux'
            'alsa-utils: alternative audio system support'
            'gum: for enhanced interactive UI (auto-installed if not present)')
makedepends=('git')
provides=('whisper-stream')
conflicts=('whisper-stream')
backup=('etc/whisper-stream/config.example')
install="$pkgname.install"
source=("$pkgname-$pkgver.tar.gz::https://github.com/b08x/whisper-stream/archive/v$pkgver.tar.gz")
sha256sums=('SKIP')

prepare() {
    cd "$pkgname-$pkgver"
    
    # Update shebang to use env
    sed -i '1s|#!/bin/bash|#! /usr/bin/env bash|' whisper-stream
    
    # Update shebang for lib files
    for lib_file in lib/*.sh; do
        if [[ -f "$lib_file" ]]; then
            sed -i '1s|#!/bin/bash|#! /usr/bin/env bash|' "$lib_file"
        fi
    done
    
    # Update shebang for scripts files
    for script_file in scripts/*.sh; do
        if [[ -f "$script_file" ]]; then
            sed -i '1s|#!/bin/bash|#! /usr/bin/env bash|' "$script_file"
        fi
    done
}

package() {
    cd "$pkgname-$pkgver"
    
    # Create directories following FHS and bashsmith patterns
    install -d "$pkgdir/usr/bin"
    install -d "$pkgdir/usr/share/$pkgname"
    install -d "$pkgdir/usr/share/$pkgname/lib"
    install -d "$pkgdir/usr/share/$pkgname/scripts"
    install -d "$pkgdir/usr/share/doc/$pkgname"
    install -d "$pkgdir/usr/share/licenses/$pkgname"
    install -d "$pkgdir/etc/$pkgname"
    
    # Install main executable (following bashsmith bin/ pattern)
    install -m755 whisper-stream "$pkgdir/usr/bin/whisper-stream"
    
    # Install library modules (following bashsmith lib/ pattern)
    for lib_file in lib/*.sh; do
        if [[ -f "$lib_file" ]]; then
            install -m644 "$lib_file" "$pkgdir/usr/share/$pkgname/lib/"
        fi
    done
    
    # Install scripts directory
    for script_file in scripts/*.sh; do
        if [[ -f "$script_file" ]]; then
            install -m755 "$script_file" "$pkgdir/usr/share/$pkgname/scripts/"
        fi
    done
    
    # Install configuration files
    install -m644 docs/dictionary.md "$pkgdir/usr/share/$pkgname/"
    
    # Create example configuration file
    cat > "$pkgdir/etc/$pkgname/config.example" << 'EOF'
# whisper-stream configuration file
# Copy this to ~/.config/whisper-stream/config and customize

# Groq API settings
GROQ_API_KEY=your_api_key_here
MODEL=whisper-large-v3-turbo

# Audio settings
MIN_VOLUME=1%
SILENCE_LENGTH=1.5

# Paths
NOTEBOOK_ROOT=$HOME/Notebooks
OUTPUT_DIR=

# Device settings (leave empty to prompt)
SELECTED_INPUT_DEVICE=
EOF
    
    # Install documentation
    install -m644 README.md "$pkgdir/usr/share/doc/$pkgname/"
    install -m644 docs/CLAUDE.md "$pkgdir/usr/share/doc/$pkgname/"
    
    # Install license
    install -m644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/"
    
    # Fix the library path in the main script to use absolute paths
    sed -i 's|SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)|SCRIPT_DIR=/usr/share/whisper-stream|' \
        "$pkgdir/usr/bin/whisper-stream"
    sed -i 's|LIB_DIR="$SCRIPT_DIR/lib"|LIB_DIR="/usr/share/whisper-stream/lib"|' \
        "$pkgdir/usr/bin/whisper-stream"
    
    # Fix the first_time_setup.sh sourcing paths
    sed -i 's|if \[\[ -f "$SCRIPT_DIR/scripts/first_time_setup.sh" \]\]; then|if [[ -f "/usr/share/whisper-stream/scripts/first_time_setup.sh" ]]; then|' \
        "$pkgdir/usr/bin/whisper-stream"
    sed -i 's|source "$SCRIPT_DIR/scripts/first_time_setup.sh"|source "/usr/share/whisper-stream/scripts/first_time_setup.sh"|' \
        "$pkgdir/usr/bin/whisper-stream"
    
    # Add gum_wrapper.sh sourcing to first_time_setup.sh
    sed -i '1a\\n# Source gum_wrapper.sh for gum functions\nsource "/usr/share/whisper-stream/lib/gum_wrapper.sh"' \
        "$pkgdir/usr/share/whisper-stream/scripts/first_time_setup.sh"
    
    # Remove the bashsmith strict settings that cause unbound variable errors
    sed -i '/# Bashsmith template patterns for safety/,/IFS=.*$/d' "$pkgdir/usr/bin/whisper-stream"
    
    # Remove bashsmith patterns from lib files too
    for lib_file in "$pkgdir/usr/share/$pkgname/lib"/*.sh; do
        if [[ -f "$lib_file" ]]; then
            sed -i '/# Bashsmith template patterns for safety/,/IFS=.*$/d' "$lib_file"
        fi
    done
    
    # Remove bashsmith patterns from scripts files
    for script_file in "$pkgdir/usr/share/$pkgname/scripts"/*.sh; do
        if [[ -f "$script_file" ]]; then
            sed -i '/# Bashsmith template patterns for safety/,/IFS=.*$/d' "$script_file"
        fi
    done
}